---
title: "Environmental"
author: "Alain Danet"
output: html_document
bibliography: "../doc/references.bib"
---

<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
      text-align: justify;
  }
td {  /* Table  */
  font-size: 18px;
}
h1.title {
  font-size: 38px;
  color: Black;
  text-align: justify;
}
h1 { /* Header 1 */
  font-size: 20px;
  color: #9e0142;
  text-align: justify;
}
h2 { /* Header 2 */
    font-size: 18px;
  color: #d53e4f;
  text-align: justify;
}
code.r{ /* Code block */
    font-size: 18px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 18px;
}
</style>


```{r setup, include=FALSE}
mypath <- rprojroot::find_package_root_file
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, dev = "svg")
knitr::opts_knit$set(root.dir = mypath())
```


```{r, include = FALSE , echo=FALSE, message = FALSE, warning = FALSE}
## R sert-up
library(sf)
library(tidyverse)
library(magrittr)
library(piecewiseSEM)
library(corrplot)
library(ade4)
library(factoextra)
library(cowplot)

source(mypath("R", "misc.R"))
myload(env_stream, env_lake, dataset_lake_stream, dir = mypath("data"))
```
# Summary  
*Stream:  
- Temperature and DBO both decrease disolved oxygen  
- Nitrogen matters has a strong positive effect on DBO  

*Lake:  
- Only temperature decreases disolved oxygen but the effect is not significant  
- Phosphore matters has a strong positive effect on DBO  


# SEM  
- disolved oxygen ~ DBO + temperature  
- DBO ~ nitrogen + phosphore + temperature  


```{r}
env_stream <- env_stream %>% filter(opcod %in% (dataset_lake_stream %>% filter(type == "stream") %>% select(opcod) %>% unique(.) %>% t(.) %>% as.character(.)))
env_lake <- na.omit(env_lake)


lm_list_stream <- list(lm(oxygen ~ dbo + temp, env_stream), lm(dbo ~ nitrogen + phosphore + temp, env_stream))
lm_list_lake <- list(lm(oxygen ~ dbo + temp, env_lake), lm(dbo ~ nitrogen + phosphore + temp, env_lake))

sem_stream <- as.psem(lm_list_stream); sem_lake <- as.psem(lm_list_lake)
summary(sem_stream); summary(sem_lake)
plot(sem_stream, title = "SEM - Stream"); plot(sem_lake, title = "SEM - Lake")
```

```{r}
#stream
performance::check_collinearity(lm_list_stream[[1]])
performance::check_collinearity(lm_list_stream[[2]])

#lake
performance::check_collinearity(lm_list_lake[[1]])
performance::check_collinearity(lm_list_lake[[2]])
```

# PCA

```{r}
env_var <- c("dbo", "temp", "oxygen", "nitrogen", "phosphore")
corrplot(cor(env_stream[, env_var]), type = "upper", diag = FALSE, title = "Stream")
corrplot(cor(env_lake[, env_var]), type = "upper", diag = FALSE, title = "Lake")
```

```{r}
pca_stream <- dudi.pca(env_stream[, env_var], nf = 3, scannf = FALSE)
pca_lake <- dudi.pca(env_lake[, env_var], nf = 3, scannf = FALSE)

p_stream <- cowplot::plot_grid(
  fviz_pca_var(pca_stream, axes = c(1, 2)),
  fviz_pca_var(pca_stream, axes = c(2, 3)))
plot_grid(ggdraw() + draw_label("Stream", fontface='bold'),
          p_stream, ncol = 1, rel_heights = c(0.1, 1))

p_lake <- cowplot::plot_grid(
  fviz_pca_var(pca_lake, axes = c(1, 2)),
  fviz_pca_var(pca_lake, axes = c(2, 3)))
plot_grid(ggdraw() + draw_label("Lake", fontface='bold'),
          p_lake, ncol = 1, rel_heights = c(0.1, 1))
```






